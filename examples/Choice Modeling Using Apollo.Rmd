---
title: "Estimating Discrete Choice Models using Apollo"
author: "Bryan Parthum"
date: "`r format(Sys.Date(), format='%B %e, %Y')`"
output:
  bookdown::html_document2:
    df_print: paged
    toc: true
    toc_float: true
    fig_caption: yes
    depth: 2
    number_sections: true
    code_folding:  hide
    theme: readable
editor_options: 
  chunk_output_type: console
---

```{r message=FALSE, warning=FALSE, echo=FALSE}
library(tidyverse)
library(magrittr)
library(kableExtra)
library(apollo)
```

This document walks a user through estimation of a discrete choice model using the [Apollo](http://www.apollochoicemodelling.com/index.html) package in [Rstudio](https://www.rstudio.com/). The example code is drawn directly from the helpful list of [examples](http://www.apollochoicemodelling.com/examples.html) found on the Apollo website.

# A Simple Multinomial Logit (MNL) model on Stated Preference Data

Start by initializing the code and setting up core controls.

```{r  include=TRUE, message=FALSE, warning=FALSE, eval=TRUE, echo=TRUE, class.source="fold-show"}

## initialize code
apollo_initialise()

## set core controls
apollo_control = list(
  modelName       = "MNL_SP",
  modelDescr      = "Simple MNL model on mode choice SP data",
  indivID         = "ID",
  outputDirectory = "output"
)
```

Next, load the example data and subset it to only include the stated preference data (SP==1). For a dictionary of available data, use `? apollo_modeChoiceData`. If necessary transform the data to be readable by Apollo. 

```{r  include=TRUE, message=FALSE, warning=FALSE, eval=TRUE, echo=TRUE, class.source="fold-show"}
## load data
database = apollo_modeChoiceData %>% 
  filter(SP==1)
```

Determine the attributes of the model and define the priors on the model parameters. If none are available, a prior of `0` should be used. Define any parameters (using the names of the parameters) that should be fixed at their starting value.

```{r  include=TRUE, message=FALSE, warning=FALSE, eval=TRUE, echo=TRUE, class.source="fold-show"}
## vector of parameters, including any that are kept fixed in estimation
apollo_beta = c(
  asc_car      = 0,
  asc_bus      = 0,
  asc_air      = 0,
  asc_rail     = 0,
  b_tt_car     = 0,
  b_tt_bus     = 0,
  b_tt_air     = 0,
  b_tt_rail    = 0,
  b_access     = 0,
  b_cost       = 0,
  b_no_frills  = 0,
  b_wifi       = 0,
  b_food       = 0
)

## vector with names (in quotes) of parameters to be kept fixed at their starting value in params, use apollo_beta_fixed = c() if none
apollo_fixed = c("asc_car","b_no_frills")
```

Group and validate the inputs of the model using the functions defined within Apollo. 

```{r  include=TRUE, message=FALSE, warning=FALSE, eval=TRUE, echo=TRUE, class.source="fold-show"}
## group and validate
apollo_inputs = apollo_validateInputs(apollo_beta,
                                      apollo_fixed,
                                      database)
```

Define the model and the likelihood function.

```{r  include=TRUE, message=FALSE, warning=FALSE, eval=TRUE, echo=TRUE, class.source="fold-show"}
## likelihood function
apollo_probabilities=function(apollo_beta, 
                              apollo_inputs, 
                              functionality="estimate"){
    
  ## attach inputs and detach after function exit
  apollo_attach(apollo_beta, apollo_inputs)
  on.exit(apollo_detach(apollo_beta, apollo_inputs))

  ## create list of probabilities P
  P = list()
  
  ## list of utilities: these must use the same names as in mnl_settings, order is irrelevant
  V = list()
  V[["car"]]  = asc_car  + b_tt_car  * time_car                           + b_cost * cost_car
  V[["bus"]]  = asc_bus  + b_tt_bus  * time_bus  + b_access * access_bus  + b_cost * cost_bus 
  V[["air"]]  = asc_air  + b_tt_air  * time_air  + b_access * access_air  + b_cost * cost_air    + b_no_frills * ( service_air == 1 )  + b_wifi * ( service_air == 2 )  + b_food * ( service_air == 3 )
  V[["rail"]] = asc_rail + b_tt_rail * time_rail + b_access * access_rail + b_cost * cost_rail   + b_no_frills * ( service_rail == 1 ) + b_wifi * ( service_rail == 2 ) + b_food * ( service_rail == 3 )
  
  ## define settings for MNL model component
  mnl_settings = list(
    alternatives  = c(car=1, bus=2, air=3, rail=4), 
    avail         = list(car=av_car, bus=av_bus, air=av_air, rail=av_rail), 
    choiceVar     = choice,
    utilities     = V
  )
  
  ## compute probabilities using MNL model
  P[["model"]] = apollo_mnl(mnl_settings, functionality)
  
  ## take product across observation for same individual
  P = apollo_panelProd(P, apollo_inputs, functionality)
  
  ## prepare and return outputs of function
  P = apollo_prepareProb(P, apollo_inputs, functionality)
  return(P)
}
```

We are now ready to estimate the model.

```{r  include=TRUE, message=FALSE, warning=FALSE, eval=TRUE, echo=TRUE, class.source="fold-show"}
## estimate
model = apollo_estimate(apollo_beta, apollo_fixed, apollo_probabilities, apollo_inputs)
```

Explore model results. 
```{r  include=TRUE, message=FALSE, warning=FALSE, eval=TRUE, echo=TRUE, class.source="fold-show"}
## model outputs
apollo_modelOutput(model)

## optional: save model output to output directory
# apollo_saveOutput(model)
```